"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var BareFoot=function(){function t(){var e=this,n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t);var o={scope:"body",divFootnotesQuery:".footnotes",footnotesQuery:"[id^='user-content-fn']",supQuery:'a[href^="#user-content-fn"]',fnButtonMarkup:'<button class="footnote-button" id="{{FOOTNOTEREFID}}" data-footnote="{{FOOTNOTEID}}" alt="See Footnote {{FOOTNOTENUMBER}}" rel="footnote" data-fn-number="{{FOOTNOTENUMBER}}" data-fn-content="{{FOOTNOTECONTENT}}" name="Footnote {{FOOTNOTENUMBER}}"></button>',fnContentMarkup:'<div class="bf-footnote" id="{{FOOTNOTEID}}"><div class="footnote-wrapper"><div class="footnote-content" tabindex="0">{{FOOTNOTECONTENT}}</div></div><div class="footnote-tooltip" aria-hidden="true"></div>',activeCallback:null,activeBtnClass:"is-active",activeFnClass:"footnote-is-active",backdropClass:"footnote-backdrop",buttonClass:"footnote-button",fnContainer:"footnote-container",fnClass:"bf-footnote",fnContentClass:"footnote-content",fnWrapperClass:"footnote-wrapper",tooltipClass:"footnote-tooltip",fnOnTopClass:"footnote-is-top"};if(this.config=_extends({},o,n),this.divFootnotes=[].slice.call(document.querySelectorAll(this.config.divFootnotesQuery)),!this.divFootnotes)return!1;this.footnotes=this.divFootnotes.map((function(t){return t.querySelectorAll(e.config.footnotesQuery)})),Element.prototype.matches=Element.prototype.matches||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(t){return-1!==[].indexOf.call(document.querySelectorAll(t),this)},Element.prototype.closest=Element.prototype.closest||function(t){for(var e=this;null!==e;){var n=e.parentElement;if(null!==n&&n.matches(t))return n;e=n}return null};var i=document.createElement("div");i.style.cssText="width: 100px; height: 100px; overflow: scroll; position: absolute; top: -9999px; visibility: hidden;",document.body.appendChild(i),this.scrollBarWidth=i.offsetWidth-i.clientWidth,document.body.removeChild(i)}return _createClass(t,[{key:"removeBackLinks",value:function(t,e){e.indexOf(" ")>=0&&(e=e.trim().replace(/\s+/g,"|").replace(/(.*)/g,"($1)")),0===e.indexOf("#")&&(e=e.slice(1));var n=new RegExp("(\\s|&nbsp;)*<\\s*a[^#<]*#"+e+"[^>]*>(.*?)<\\s*/\\s*a>","g");return t.replace(n,"").replace("[]","")}},{key:"buildButton",value:function(t,e,n,o){return this.config.fnButtonMarkup.replace(/\{\{FOOTNOTEREFID\}\}/g,t).replace(/\{\{FOOTNOTEID\}\}/g,e).replace(/\{\{FOOTNOTENUMBER\}\}/g,n).replace(/\{\{FOOTNOTECONTENT\}\}/g,o)}},{key:"buildContent",value:function(t,e){return this.config.fnContentMarkup.replace(/\{\{FOOTNOTEID\}\}/g,t).replace(/\{\{FOOTNOTECONTENT\}\}/g,e)}},{key:"clickAction",value:function(t){var e,n,o,i,s,a=void 0,c=void 0;e=(a=t.target).getAttribute("data-fn-content"),n=a.getAttribute("data-footnote"),s=a.classList.contains("is-active"),i=this.getScrollHeight(),this.dismissFootnotes(),s||(o=this.buildContent(n,e),a.insertAdjacentHTML("afterend",o),c=a.nextElementSibling,this.calculateOffset(c,a),this.calculateSpacing(c,i),a.classList.add(this.config.activeBtnClass),c.classList.add(this.config.activeFnClass),c.querySelector("."+this.config.fnContentClass).focus(),"ontouchstart"in document.documentElement&&document.body.classList.add(this.config.backdropClass),this.config.activeCallback&&this.config.activeCallback(a,c))}},{key:"calculateOffset",value:function(t,e){var n,o,i,s,a,c,l,r=void 0,u=void 0;(e=e||t.previousElementSibling).offsetLeft,e.offsetWidth,a=(r=t.querySelector("."+this.config.tooltipClass)).clientWidth,o=(n=t.parentNode).clientWidth,i=n.offsetLeft,u=-((s=t.offsetWidth)/2-o/2),l=window.innerWidth||window.availWidth,i+u<0?u-=i+u:i+u+s+this.scrollBarWidth>l&&(u-=i+u+s+this.scrollBarWidth+o/2-l),t.style.left=u+"px",c=i-(i+u)+o/2-a/2,r.style.left=c+"px"}},{key:"removeFootnoteChild",value:function(t){return t.parentNode.removeChild(t)}},{key:"debounce",value:function(t,e,n){var o;return function(){for(var i=this,s=arguments.length,a=Array(s),c=0;c<s;c++)a[c]=arguments[c];var l=function(){o=null,n||t.apply(i,a)};clearTimeout(o),o=setTimeout(l,e),n&&!o&&t.apply(this,a)}}},{key:"resizeAction",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);e.length&&[].forEach.call(e,(function(e){t.calculateOffset(e),t.calculateSpacing(e)}))}},{key:"getScrollHeight",value:function(){return document.documentElement.scrollHeight}},{key:"calculateSpacing",value:function(t,e){var n,o,i,s,a;s=this.calculateMargins(t),a=window.innerHeight||window.availHeight,o=(n=t.getBoundingClientRect()).height,i=n.bottom,e<this.getScrollHeight()||i>a-s.bottom?t.classList.add(this.config.fnOnTopClass):a-(o+s.top)>i&&t.classList.contains(this.config.fnOnTopClass)&&t.classList.remove(this.config.fnOnTopClass)}},{key:"scrollAction",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);e.length&&(window.innerHeight||window.availHeight,this.calculateMargins(e[0]),[].forEach.call(e,(function(e){t.calculateSpacing(e)})))}},{key:"calculateMargins",value:function(t){var e=window.getComputedStyle(t,null);return{top:parseFloat(e.marginTop),right:parseFloat(e.marginRight),bottom:parseFloat(e.marginBottom),left:parseFloat(e.marginLeft)}}},{key:"documentAction",value:function(t){t.target.closest("."+this.config.fnContainer)||this.dismissFootnotes()}},{key:"dismissOnEsc",value:function(t){if(27===t.keyCode&&document.activeElement.matches("."+this.config.fnContentClass))return document.activeElement.closest("."+this.config.activeFnClass).previousElementSibling.focus(),this.dismissFootnotes()}},{key:"dismissFootnotes",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);e.length&&[].forEach.call(e,(function(e){e.previousElementSibling.classList.remove(t.config.activeBtnClass),e.addEventListener("transitionend",t.removeFootnoteChild(e),!1),e.classList.remove(t.config.activeFnClass)})),document.body.classList.contains(this.config.backdropClass)&&document.body.classList.remove(this.config.backdropClass)}},{key:"init",value:function(){var t=this;[].forEach.call(this.footnotes,(function(e,n){var o=e[0].closest(t.config.scope);[].forEach.call(e,(function(e,n){var i,s,a=void 0,c=void 0,l=void 0;i=n+1,c=e.querySelector(t.config.supQuery).getAttribute("href"),0!==(a=(a=t.removeBackLinks(e.innerHTML.trim(),c)).replace(/"/g,"&quot;").replace(/&lt;/g,"&ltsym;").replace(/&gt;/g,"&gtsym;")).indexOf("<")&&(a="<p>"+a+"</p>"),l=o.querySelector(c.replace(":","\\:")),s='<div class="'+t.config.fnContainer+'">'+t.buildButton(c,e.id,i,a)+"</div>",l.insertAdjacentHTML("afterend",s),l.parentNode.removeChild(l)}))})),[].forEach.call(document.querySelectorAll("."+this.config.buttonClass),(function(e){e.addEventListener("click",t.clickAction.bind(t))})),window.addEventListener("resize",this.debounce(this.resizeAction.bind(this),100)),window.addEventListener("scroll",this.debounce(this.scrollAction.bind(this),100)),window.addEventListener("keyup",this.dismissOnEsc.bind(this)),document.body.addEventListener("click",this.documentAction.bind(this)),document.body.addEventListener("touchend",this.documentAction.bind(this)),this.divFootnotes.forEach((function(t){return t.parentNode.removeChild(t)}))}}]),t}();