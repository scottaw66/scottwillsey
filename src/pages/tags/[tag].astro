---
import { getCollection } from "astro:content";
import Base from "../../layouts/Base.astro";
import { postdate } from "../../components/utilities/DateFormat.js";
import { titleCase } from "../../components/utilities/StringFormat.js";
import CalendarFillIcon from "../../components/icons/CalendarFillIcon.astro";

export async function getStaticPaths({}) {
  const allPosts = await getCollection("posts");
  const sortedPosts = allPosts.sort(
    (a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf(),
  );
  const allTags = new Set();
  sortedPosts.map((post) => {
    post.data.keywords && post.data.keywords.map((tag) => allTags.add(tag));
  });

  return Array.from(allTags).map((tag) => {
    const filteredPosts = sortedPosts.filter((post) =>
      post.data.keywords.includes(tag),
    );
    return {
      params: { tag },
      props: {
        posts: filteredPosts,
      },
    };
  });
}

const { posts } = Astro.props;
const { tag } = Astro.params;

let title = tag;
let description = "Posts with tag " + tag + ".";
---

<Base title={title} description={description}>
  <article data-pagefind-ignore>
    <h1>
      <a href={`/tags/${tag}`}>#{title}</a>
    </h1>
    <section aria-label="Blog post list">
      {
        posts.map((post) => (
          <header class="bg-surface-menu rounded-lg px-8 py-2 my-4">
            <h3 class="my-[0.3em]">
              <a href={`/${post.id}`}>{titleCase(post.data.title)}</a>
            </h3>
            <div class="text-[0.6em] font-bold my-3">
              <CalendarFillIcon size="1em" fill="var(--dates)" margin="0.25" />
              <time datetime={post.data.date}>
                <a href={`/${post.id}`} class="text-dates">
                  {postdate(post.data.date)}
                </a>
              </time>
            </div>
            <div class="text-[0.75em]">{post.data.description}</div>
          </header>
        ))
      }
      <p class="mx-6 my-[1.5em]">
        <a href="/tags">Browse all tags</a>
      </p>
    </section>
  </article>
</Base>
