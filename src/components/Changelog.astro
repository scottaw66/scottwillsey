---
import { getEntry } from "astro:content";
import HistoryIcon from "./icons/HistoryIcon.astro";

const changelog = await getEntry("changelog", "changelog");

// Parse the content to extract the last 5 entries
const content = changelog?.body || "";
const entries = content.split(/^### /m).filter((entry) => entry.trim());
const lastFive = entries.slice(0, 3);
---

<div>
  <h2 class="text-[1.5rem]">
    <div class="text-hyperlink ml-2">
      <a href="/changelog" class="text-hyperlink">Code Changelog</a>
      <HistoryIcon size="1.25rem" fill="var(--hyperlink)" />
    </div>
  </h2>
  <section class="text-[0.65em]">
    <ul>
      {
        lastFive.map((entry) => {
          const [date, ...description] = entry.split("\n");
          let desc = description.join(" ").trim().split("\n")[0];
          // Remove markdown links that wrap images: [![alt](image)](url)
          desc = desc.replace(/\[!\[[^\]]*\]\([^)]+\)\]\([^)]+\)/g, "");
          // Remove standalone markdown image links: ![alt](image)
          desc = desc.replace(/!\[[^\]]*\]\([^)]+\)/g, "");
          // Remove any markdown links that point to image files
          desc = desc.replace(
            /\[([^\]]+)\]\(([^)]*\.(jpg|jpeg|png|gif|webp|svg)[^)]*)\)/gi,
            "",
          );
          // Convert remaining markdown links [text](url) to HTML links
          desc = desc.replace(
            /\[([^\]]+)\]\(([^)]+)\)/g,
            '<a href="$2">$1</a>',
          );
          return (
            <li>
              <strong>{date.trim()}</strong>: <span set:html={desc} />
            </li>
          );
        })
      }
    </ul>
  </section>
</div>
